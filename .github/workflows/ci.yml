name: CI

on:
  push:
    branches: [ main, claude/** ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x, 22.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build
      run: npm run build

    - name: Run tests
      run: npm test -- --coverage --maxWorkers=2
      env:
        CI: true

    - name: Upload coverage to Codecov
      if: matrix.node-version == '20.x'
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run TypeScript compiler check
      run: npx tsc --noEmit

  integration:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build
      run: npm run build

    - name: Start integration test infrastructure
      run: docker compose -f tests/integration/docker-compose.yml up -d

    - name: Wait for services to be ready
      run: |
        echo "Waiting for PostgreSQL..."
        timeout 30 bash -c 'until docker compose -f tests/integration/docker-compose.yml exec -T postgres pg_isready -U test; do sleep 1; done'
        echo "Waiting for RabbitMQ..."
        timeout 30 bash -c 'until docker compose -f tests/integration/docker-compose.yml exec -T rabbitmq rabbitmqctl status; do sleep 1; done'
        echo "Waiting for Redis..."
        timeout 30 bash -c 'until docker compose -f tests/integration/docker-compose.yml exec -T redis redis-cli ping; do sleep 1; done'
        echo "All services ready!"

    - name: Run integration tests
      run: npm run test:integration
      env:
        CI: true
        INTEGRATION_TEST: true

    - name: Stop integration test infrastructure
      if: always()
      run: docker compose -f tests/integration/docker-compose.yml down -v

  distributed:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build and start distributed example
      run: |
        cd examples/distributed
        docker compose build
        docker compose up -d

    - name: Wait for services to be healthy
      run: |
        echo "Waiting for RabbitMQ..."
        timeout 60 bash -c 'until docker compose -f examples/distributed/docker-compose.yml exec -T rabbitmq rabbitmq-diagnostics -q check_port_connectivity; do sleep 2; done'
        echo "Waiting for PostgreSQL..."
        timeout 30 bash -c 'until docker compose -f examples/distributed/docker-compose.yml exec -T postgres pg_isready -U xcomponent -d xcomponent_fsm; do sleep 1; done'
        echo "Waiting for Dashboard..."
        timeout 60 bash -c 'until curl -sf http://localhost:3000/health; do sleep 2; done'
        echo "Waiting for runtimes to register..."
        sleep 10

    - name: Verify dashboard health
      run: |
        echo "Checking dashboard health endpoint..."
        curl -sf http://localhost:3000/health | jq .

    - name: Verify runtimes registered
      run: |
        echo "Checking connected runtimes..."
        RUNTIMES=$(curl -sf http://localhost:3000/api/runtimes | jq '.runtimes | length')
        echo "Connected runtimes: $RUNTIMES"
        if [ "$RUNTIMES" -lt 2 ]; then
          echo "ERROR: Expected at least 2 runtimes, got $RUNTIMES"
          docker compose -f examples/distributed/docker-compose.yml logs
          exit 1
        fi

    - name: Verify components registered
      run: |
        echo "Checking registered components..."
        curl -sf http://localhost:3000/api/components | jq .
        COMPONENTS=$(curl -sf http://localhost:3000/api/components | jq '.components | length')
        echo "Registered components: $COMPONENTS"
        if [ "$COMPONENTS" -lt 2 ]; then
          echo "ERROR: Expected at least 2 components (Order, Payment), got $COMPONENTS"
          docker compose -f examples/distributed/docker-compose.yml logs
          exit 1
        fi

    - name: Run E2E cross-component test
      run: |
        echo "Running E2E test for cross-component communication..."
        node examples/distributed/e2e-test.js

    - name: Show logs on failure
      if: failure()
      run: |
        echo "=== Dashboard logs ==="
        docker compose -f examples/distributed/docker-compose.yml logs dashboard
        echo "=== Order runtime logs ==="
        docker compose -f examples/distributed/docker-compose.yml logs runtime-order
        echo "=== Payment runtime logs ==="
        docker compose -f examples/distributed/docker-compose.yml logs runtime-payment

    - name: Stop distributed example
      if: always()
      run: docker compose -f examples/distributed/docker-compose.yml down -v

  distributed-redis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build and start distributed Redis example
      run: |
        cd examples/distributed-redis
        docker compose build
        docker compose up -d

    - name: Wait for services to be healthy
      run: |
        echo "Waiting for Redis..."
        timeout 30 bash -c 'until docker compose -f examples/distributed-redis/docker-compose.yml exec -T redis redis-cli ping; do sleep 1; done'
        echo "Waiting for PostgreSQL..."
        timeout 30 bash -c 'until docker compose -f examples/distributed-redis/docker-compose.yml exec -T postgres pg_isready -U xcomponent -d xcomponent_fsm; do sleep 1; done'
        echo "Waiting for Dashboard..."
        timeout 60 bash -c 'until curl -sf http://localhost:3000/health; do sleep 2; done'
        echo "Waiting for runtimes to register..."
        sleep 10

    - name: Verify dashboard health
      run: |
        echo "Checking dashboard health endpoint..."
        curl -sf http://localhost:3000/health | jq .

    - name: Verify runtimes registered
      run: |
        echo "Checking connected runtimes..."
        RUNTIMES=$(curl -sf http://localhost:3000/api/runtimes | jq '.runtimes | length')
        echo "Connected runtimes: $RUNTIMES"
        if [ "$RUNTIMES" -lt 2 ]; then
          echo "ERROR: Expected at least 2 runtimes, got $RUNTIMES"
          docker compose -f examples/distributed-redis/docker-compose.yml logs
          exit 1
        fi

    - name: Verify components registered
      run: |
        echo "Checking registered components..."
        curl -sf http://localhost:3000/api/components | jq .
        COMPONENTS=$(curl -sf http://localhost:3000/api/components | jq '.components | length')
        echo "Registered components: $COMPONENTS"
        if [ "$COMPONENTS" -lt 2 ]; then
          echo "ERROR: Expected at least 2 components (Order, Payment), got $COMPONENTS"
          docker compose -f examples/distributed-redis/docker-compose.yml logs
          exit 1
        fi

    - name: Run E2E cross-component test (Redis)
      run: |
        echo "Running E2E test for cross-component communication (Redis broker)..."
        node examples/distributed-redis/e2e-test.js

    - name: Show logs on failure
      if: failure()
      run: |
        echo "=== Dashboard logs ==="
        docker compose -f examples/distributed-redis/docker-compose.yml logs dashboard
        echo "=== Order runtime logs ==="
        docker compose -f examples/distributed-redis/docker-compose.yml logs runtime-order
        echo "=== Payment runtime logs ==="
        docker compose -f examples/distributed-redis/docker-compose.yml logs runtime-payment

    - name: Stop distributed Redis example
      if: always()
      run: docker compose -f examples/distributed-redis/docker-compose.yml down -v

  monolith-postgres:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build and start monolith example
      run: |
        cd examples/monolith-postgres
        docker compose build
        docker compose up -d

    - name: Wait for services to be healthy
      run: |
        echo "Waiting for PostgreSQL..."
        timeout 30 bash -c 'until docker compose -f examples/monolith-postgres/docker-compose.yml exec -T postgres pg_isready -U xcomponent -d xcomponent_fsm; do sleep 1; done'
        echo "Waiting for Dashboard..."
        timeout 60 bash -c 'until curl -sf http://localhost:3000/health; do sleep 2; done'
        echo "Waiting for runtimes to register via in-memory broker..."
        sleep 5

    - name: Verify dashboard health
      run: |
        echo "Checking dashboard health endpoint..."
        curl -sf http://localhost:3000/health | jq .

    - name: Verify runtimes registered
      run: |
        echo "Checking connected runtimes..."
        RUNTIMES=$(curl -sf http://localhost:3000/api/runtimes | jq '.runtimes | length')
        echo "Connected runtimes: $RUNTIMES"
        if [ "$RUNTIMES" -lt 2 ]; then
          echo "ERROR: Expected at least 2 runtimes, got $RUNTIMES"
          docker compose -f examples/monolith-postgres/docker-compose.yml logs
          exit 1
        fi

    - name: Verify components registered
      run: |
        echo "Checking registered components..."
        curl -sf http://localhost:3000/api/components | jq .
        COMPONENTS=$(curl -sf http://localhost:3000/api/components | jq '.components | length')
        echo "Registered components: $COMPONENTS"
        if [ "$COMPONENTS" -lt 2 ]; then
          echo "ERROR: Expected at least 2 components (Order, Payment), got $COMPONENTS"
          docker compose -f examples/monolith-postgres/docker-compose.yml logs
          exit 1
        fi

    - name: Verify database is connected
      run: |
        echo "Checking database availability via health..."
        DB=$(curl -sf http://localhost:3000/health | jq '.database')
        echo "Database available: $DB"
        if [ "$DB" != "true" ]; then
          echo "ERROR: PostgreSQL should be connected"
          exit 1
        fi

    - name: Run E2E cross-component test (Monolith + PostgreSQL)
      run: |
        echo "Running E2E test for monolith mode with PostgreSQL persistence..."
        DATABASE_URL=postgresql://xcomponent:xcomponent123@localhost:5432/xcomponent_fsm node examples/monolith-postgres/e2e-test.js

    - name: Show logs on failure
      if: failure()
      run: |
        echo "=== App logs ==="
        docker compose -f examples/monolith-postgres/docker-compose.yml logs app
        echo "=== PostgreSQL logs ==="
        docker compose -f examples/monolith-postgres/docker-compose.yml logs postgres

    - name: Stop monolith example
      if: always()
      run: docker compose -f examples/monolith-postgres/docker-compose.yml down -v

  docs:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate documentation
      run: npm run doc

    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/
