# Order Component - Distributed Demo (Redis)
# Manages orders and requests payment processing via cross-component messaging

name: OrderComponent
version: 1.0.0
entryMachine: Order

stateMachines:
  - name: Order
    initialState: Created

    contextSchema:
      orderId:
        type: text
        label: Order ID
        required: true
      amount:
        type: number
        label: Amount
        required: true
      customerId:
        type: text
        label: Customer ID
      paymentMethod:
        type: text
        label: Payment Method

    states:
      - name: Created
        type: entry

      - name: PendingPayment
        type: regular
        onEntry: notifyPaymentPending

      - name: Paid
        type: regular
        onEntry: notifyPaymentReceived

      - name: Shipped
        type: regular
        onEntry: notifyShipped

      - name: Completed
        type: final
        onEntry: notifyDelivered

      - name: Cancelled
        type: final
        onEntry: notifyCancelled

    transitions:
      # Submit order - triggers payment request to PaymentComponent
      # contextMapping: only send orderId and amount (not customerId)
      - from: Created
        to: PendingPayment
        event: SUBMIT
        type: cross_component
        targetComponent: PaymentComponent
        targetMachine: Payment
        contextMapping:
          orderId: orderId
          amount: amount
          paymentMethod: paymentMethod
        description: Submit order and request payment

      # Payment confirmed - received from PaymentComponent
      - from: PendingPayment
        to: Paid
        event: PAYMENT_CONFIRMED
        type: triggerable
        description: Payment was successful

      # Payment failed - received from PaymentComponent
      - from: PendingPayment
        to: Cancelled
        event: PAYMENT_FAILED
        type: triggerable
        description: Payment failed

      # Ship the order
      - from: Paid
        to: Shipped
        event: SHIP
        type: triggerable

      # Complete delivery
      - from: Shipped
        to: Completed
        event: DELIVER
        type: triggerable

      # Cancel from any non-final state
      - from: Created
        to: Cancelled
        event: CANCEL
        type: triggerable
