# Explicit Transitions Demo
# Shows the new sender.sendToSelf() pattern for explicit control

name: ExplicitTransitionsComponent
version: 1.0.0
metadata:
  description: Demonstrates explicit transition control with sender.sendToSelf()

# Triggered method handlers are implemented in TypeScript using:
#   runtime.on('triggered_method', async ({ method, event, context, sender }) => { ... })

stateMachines:
  - name: Order
    initialState: Created

    contextSchema:
      orderId:
        type: text
        required: true
      customerId:
        type: text
        required: true
      symbol:
        type: text
        required: true
      totalQuantity:
        type: number
        required: true
        min: 1
      side:
        type: select
        options:
          - BUY
          - SELL
        required: true
      startTime:
        type: number
        default: 0

    states:
      - name: Created
        type: entry

      - name: Submitted
        type: regular

      - name: PartiallyExecuted
        type: regular
        description: Receiving executions, accumulating quantity

      - name: FullyExecuted
        type: regular
        description: All quantity executed

      - name: Completed
        type: final

      - name: Expired
        type: error
        description: Timed out before completion

    transitions:
      # Submit order
      - from: Created
        to: Submitted
        event: SUBMIT
        type: triggerable

      # First execution
      - from: Submitted
        to: PartiallyExecuted
        event: EXECUTION_NOTIFICATION
        type: triggerable
        triggeredMethod: accumulateExecution

      # SELF-LOOP: Stay in PartiallyExecuted
      # Triggered method decides when to send FULLY_EXECUTED event
      - from: PartiallyExecuted
        to: PartiallyExecuted
        event: EXECUTION_NOTIFICATION
        type: triggerable
        triggeredMethod: accumulateExecution

      # EXPLICIT TRANSITION: Triggered by sender.sendToSelf() in accumulateExecution
      # No guards! Logic is in the triggered method
      - from: PartiallyExecuted
        to: FullyExecuted
        event: FULLY_EXECUTED
        type: triggerable
        triggeredMethod: handleCompletion

      # Complete order
      - from: FullyExecuted
        to: Completed
        event: SETTLE
        type: triggerable

      # Timeout (parallel to executions)
      - from: PartiallyExecuted
        to: Expired
        event: TIMEOUT
        type: timeout
        timeoutMs: 30000
        resetOnTransition: false  # Total time in state
        triggeredMethod: handleExpiration

  - name: RiskMonitor
    initialState: Created

    contextSchema:
      customerId:
        type: text
        required: true

    states:
      - name: Created
        type: entry

      - name: Monitoring
        type: regular

      - name: Stopped
        type: final

    transitions:
      - from: Created
        to: Monitoring
        event: START
        type: triggerable

      # Receive updates via matchingRules
      - from: Monitoring
        to: Monitoring
        event: ORDER_UPDATE
        type: triggerable
        triggeredMethod: updateRiskMetrics
        matchingRules:
          # Only receive events for orders with matching customerId
          - eventProperty: payload.customerId
            instanceProperty: customerId

      - from: Monitoring
        to: Stopped
        event: STOP
        type: triggerable
