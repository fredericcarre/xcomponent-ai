<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>xcomponent-ai Dashboard</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }

    .container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px 30px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      color: #fbbf24;
    }

    .component-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .component-selector select {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }

    /* Main Layout */
    .main-layout {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 20px;
      height: calc(100vh - 140px);
    }

    /* Left Panel - Machines & Instances */
    .left-panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      overflow-y: auto;
    }

    .machine-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .machine-card:hover {
      border-color: #fbbf24;
      background: rgba(251, 191, 36, 0.1);
    }

    .machine-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .machine-name {
      font-size: 16px;
      font-weight: 600;
      color: #fbbf24;
    }

    .entry-star {
      color: #fbbf24;
      font-size: 18px;
    }

    .instance-badge {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .instance-item {
      background: rgba(255, 255, 255, 0.03);
      border-left: 3px solid #666;
      padding: 10px;
      margin: 8px 0;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
      transition: all 0.2s;
    }

    .instance-item:hover {
      background: rgba(251, 191, 36, 0.1);
      border-left-color: #fbbf24;
      transform: translateX(4px);
    }

    .instance-item.selected {
      background: rgba(251, 191, 36, 0.2);
      border-left-color: #fbbf24;
    }

    .instance-id {
      font-family: monospace;
      font-size: 13px;
      color: #aaa;
    }

    .instance-state {
      font-size: 14px;
      font-weight: 600;
      color: white;
      margin-top: 4px;
    }

    .state-final { color: #10b981; }
    .state-error { color: #ef4444; }
    .state-active { color: #3b82f6; }

    /* Right Panel - Instance Detail */
    .right-panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 30px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .instance-detail-header {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .instance-detail-header h2 {
      color: #fbbf24;
      font-size: 20px;
      margin-bottom: 8px;
    }

    .instance-info {
      display: flex;
      gap: 20px;
      font-size: 14px;
      color: #aaa;
    }

    /* Diagram Container */
    .diagram-section {
      flex: 1;
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    /* History Timeline */
    .history-section {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .history-section h3 {
      color: #fbbf24;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .history-item {
      display: flex;
      align-items: center;
      padding: 12px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      border-left: 3px solid #10b981;
    }

    .history-time {
      color: #888;
      font-size: 12px;
      min-width: 80px;
    }

    .history-transition {
      flex: 1;
      font-size: 14px;
    }

    .history-arrow {
      color: #10b981;
      margin: 0 10px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    /* Create Instance Button */
    .create-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #000;
      padding: 16px 32px;
      border-radius: 30px;
      border: none;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 30px rgba(251, 191, 36, 0.4);
      transition: all 0.3s;
    }

    .create-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 40px rgba(251, 191, 36, 0.6);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      margin-bottom: 20px;
    }

    .modal-header h2 {
      color: #fbbf24;
      font-size: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #aaa;
      font-size: 14px;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: white;
      font-size: 14px;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #fbbf24;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #000;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚ö° xcomponent-ai Dashboard</h1>
      <div class="component-selector">
        <span style="color: #aaa; font-size: 14px;">Component:</span>
        <select id="component-select" onchange="selectComponent()">
          <option value="">Loading...</option>
        </select>
      </div>
    </div>

    <div class="main-layout">
      <!-- Left Panel: Machines & Instances -->
      <div class="left-panel" id="machines-panel">
        <div class="empty-state">
          <div class="empty-state-icon">üèóÔ∏è</div>
          <div>Loading components...</div>
        </div>
      </div>

      <!-- Right Panel: Instance Detail -->
      <div class="right-panel" id="instance-detail-panel">
        <div class="empty-state">
          <div class="empty-state-icon">üëà</div>
          <div>Select an instance to view details</div>
        </div>
      </div>
    </div>

    <!-- Create Instance Button -->
    <button class="create-btn" onclick="openCreateModal()">+ Create Instance</button>

    <!-- Create Instance Modal -->
    <div class="modal" id="create-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Create New Instance</h2>
        </div>
        <div class="form-group">
          <label>State Machine</label>
          <select id="create-machine">
            <option value="">Select a machine...</option>
          </select>
        </div>
        <div id="create-form-fields"></div>
        <div class="modal-actions">
          <button class="btn btn-primary" onclick="createInstance()">Create</button>
          <button class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    let componentsData = [];
    let selectedComponentName = null;
    let instances = [];
    let selectedInstanceId = null;
    let instanceHistory = new Map(); // instanceId -> [{transition, timestamp}]

    // WebSocket connection
    socket.on('connect', () => console.log('Connected'));
    socket.on('disconnect', () => console.log('Disconnected'));

    socket.on('components_data', (data) => {
      componentsData = data.components || [];
      if (componentsData.length > 0) {
        selectedComponentName = componentsData[0].name;
        populateComponentSelector();
        loadInstances();
      }
    });

    socket.on('instance_created', (data) => {
      loadInstances();
    });

    socket.on('state_change', (data) => {
      // Add to history
      if (!instanceHistory.has(data.instanceId)) {
        instanceHistory.set(data.instanceId, []);
      }
      instanceHistory.get(data.instanceId).push({
        previousState: data.previousState,
        newState: data.newState,
        event: data.event.type,
        timestamp: data.timestamp
      });

      loadInstances();
      if (selectedInstanceId === data.instanceId) {
        renderInstanceDetail(selectedInstanceId);
      }
    });

    function getCurrentComponent() {
      if (!selectedComponentName) return null;
      return componentsData.find(c => c.name === selectedComponentName);
    }

    function populateComponentSelector() {
      const select = document.getElementById('component-select');
      select.innerHTML = componentsData.map(c =>
        `<option value="${c.name}" ${c.name === selectedComponentName ? 'selected' : ''}>${c.name}</option>`
      ).join('');
    }

    function selectComponent() {
      selectedComponentName = document.getElementById('component-select').value;
      selectedInstanceId = null;
      loadInstances();
    }

    async function loadInstances() {
      const res = await fetch('/api/instances');
      const data = await res.json();
      instances = data.instances || [];
      renderMachinesPanel();
      if (selectedInstanceId) {
        renderInstanceDetail(selectedInstanceId);
      }
    }

    function renderMachinesPanel() {
      const component = getCurrentComponent();
      if (!component) return;

      const panel = document.getElementById('machines-panel');
      const machinesHtml = component.stateMachines.map(machine => {
        const machineInstances = instances.filter(i => i.machineName === machine.name);
        const isEntryPoint = component.entryMachine === machine.name;

        return `
          <div class="machine-card">
            <div class="machine-header">
              <div>
                ${isEntryPoint ? '<span class="entry-star">‚≠ê</span> ' : ''}
                <span class="machine-name">${machine.name}</span>
              </div>
              <span class="instance-badge">${machineInstances.length}</span>
            </div>
            ${machineInstances.length > 0 ? `
              <div>
                ${machineInstances.map(inst => `
                  <div class="instance-item ${selectedInstanceId === inst.id ? 'selected' : ''}"
                       onclick="selectInstance('${inst.id}')">
                    <div class="instance-id">${inst.id.substring(0, 8)}</div>
                    <div class="instance-state state-${inst.status}">${inst.currentState}</div>
                  </div>
                `).join('')}
              </div>
            ` : '<div style="color: #666; font-size: 12px; margin-top: 8px;">No instances</div>'}
          </div>
        `;
      }).join('');

      panel.innerHTML = machinesHtml;
    }

    function selectInstance(instanceId) {
      selectedInstanceId = instanceId;
      renderMachinesPanel();
      renderInstanceDetail(instanceId);
    }

    async function renderInstanceDetail(instanceId) {
      const instance = instances.find(i => i.id === instanceId);
      if (!instance) return;

      const component = getCurrentComponent();
      const machine = component.stateMachines.find(m => m.name === instance.machineName);
      if (!machine) return;

      const panel = document.getElementById('instance-detail-panel');

      // Get history for this instance
      const history = instanceHistory.get(instanceId) || [];

      panel.innerHTML = `
        <div class="instance-detail-header">
          <h2>${instance.machineName} - ${instance.id.substring(0, 12)}</h2>
          <div class="instance-info">
            <span>Current State: <strong style="color: #fbbf24;">${instance.currentState}</strong></span>
            <span>Status: <strong>${instance.status}</strong></span>
            ${instance.isEntryPoint ? '<span style="color: #fbbf24;">‚≠ê Entry Point</span>' : ''}
          </div>
        </div>

        <div class="diagram-section">
          <div id="instance-diagram"></div>
        </div>

        <div class="history-section">
          <h3>üìú Transition History</h3>
          ${history.length > 0 ? history.map(h => `
            <div class="history-item">
              <div class="history-time">${new Date(h.timestamp).toLocaleTimeString()}</div>
              <div class="history-transition">
                ${h.previousState} <span class="history-arrow">‚Üí</span> ${h.newState}
                <div style="font-size: 12px; color: #888; margin-top: 4px;">Event: ${h.event}</div>
              </div>
            </div>
          `).join('') : '<div style="color: #666; text-align: center; padding: 20px;">No transitions yet</div>'}
        </div>
      `;

      // Render diagram with current state highlighted
      renderInstanceDiagram(machine, instance.currentState);
    }

    async function renderInstanceDiagram(machine, currentState) {
      // Fetch diagram from API
      const component = getCurrentComponent();
      const res = await fetch(`/api/components/${component.name}/diagrams/${machine.name}`);
      const data = await res.json();

      if (data.diagram) {
        const container = document.getElementById('instance-diagram');

        // Add current state highlighting to the diagram
        const highlighted = data.diagram + `\n\n    style ${currentState} fill:#fbbf24,stroke:#f59e0b,stroke-width:4px,color:#000`;

        container.innerHTML = '<div class="mermaid">' + highlighted + '</div>';

        try {
          await mermaid.run({ querySelector: '#instance-diagram .mermaid' });
        } catch (error) {
          console.error('Mermaid error:', error);
          container.innerHTML = '<div style="color: #ef4444;">Diagram rendering error</div>';
        }
      }
    }

    // Create Instance Modal
    function openCreateModal() {
      const component = getCurrentComponent();
      if (!component) return;

      const select = document.getElementById('create-machine');
      select.innerHTML = '<option value="">Select...</option>' +
        component.stateMachines.map(m => `<option value="${m.name}">${m.name}</option>`).join('');

      document.getElementById('create-modal').classList.add('active');
    }

    function closeCreateModal() {
      document.getElementById('create-modal').classList.remove('active');
      document.getElementById('create-form-fields').innerHTML = '';
    }

    document.getElementById('create-machine').addEventListener('change', (e) => {
      const machineName = e.target.value;
      const component = getCurrentComponent();
      if (!machineName || !component) return;

      const machine = component.stateMachines.find(m => m.name === machineName);
      if (!machine || !machine.contextSchema) {
        document.getElementById('create-form-fields').innerHTML = `
          <div class="form-group">
            <label>Context (JSON)</label>
            <textarea id="context-json" rows="4" placeholder='{"property": "value"}'></textarea>
          </div>
        `;
        return;
      }

      let html = '';
      for (const [key, field] of Object.entries(machine.contextSchema)) {
        html += `
          <div class="form-group">
            <label>${field.label || key}${field.required ? ' *' : ''}</label>
            ${field.type === 'select' ? `
              <select id="ctx_${key}">
                ${field.options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
              </select>
            ` : `
              <input type="${field.type || 'text'}" id="ctx_${key}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>
            `}
          </div>
        `;
      }
      document.getElementById('create-form-fields').innerHTML = html;
    });

    async function createInstance() {
      const machineName = document.getElementById('create-machine').value;
      const component = getCurrentComponent();
      if (!machineName || !component) return alert('Please select a machine');

      const machine = component.stateMachines.find(m => m.name === machineName);
      let context = {};

      if (machine?.contextSchema) {
        for (const key of Object.keys(machine.contextSchema)) {
          const input = document.getElementById('ctx_' + key);
          if (input && input.value) {
            context[key] = input.type === 'number' ? parseFloat(input.value) : input.value;
          }
        }
      } else {
        const json = document.getElementById('context-json')?.value;
        if (json) {
          try {
            context = JSON.parse(json);
          } catch (e) {
            return alert('Invalid JSON: ' + e.message);
          }
        }
      }

      await fetch(`/api/components/${component.name}/instances`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({machineName, context})
      });

      closeCreateModal();
      loadInstances();
    }

    // Initialize
    mermaid.initialize({startOnLoad: false, theme: 'default'});
  </script>
</body>
</html>
